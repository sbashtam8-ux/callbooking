<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Callbooking Performance</title>
<style>
:root{
  --green1:#66d17a;
  --green2:#0b7a3f;
  --yellow:#fef3c7;
  --red:#d72631cc;
  --bg:#f0f2f5;
  --gold:#d4af37;
}
*{box-sizing:border-box}
body{font-family:Calibri, sans-serif;background:var(--bg);margin:0;padding:0;direction:rtl;color:#111}
header{
  background:linear-gradient(90deg,var(--green1),var(--green2));
  color:#fff;padding:20px;text-align:center;font-size:24px;font-weight:800;
  box-shadow:0 4px 12px rgba(0,0,0,0.12);display:flex;justify-content:space-between;align-items:center;
}
.lock-section{display:flex;align-items:center;gap:12px;font-size:14px}
.lock-icon{font-size:18px;cursor:pointer;color:var(--gold)}
main{max-width:1100px;margin:18px auto;padding:16px;display:flex;flex-direction:column;gap:16px}
.card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
h2{margin:0 0 10px;color:var(--green2);font-size:18px}
.row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.row label{min-width:140px;text-align:right;font-weight:600}
.small-input{width:260px;padding:8px;border:1px solid #ccc;border-radius:8px;font-size:14px}
.full-input{flex:1;padding:8px;border:1px solid #ccc;border-radius:8px;font-size:14px}
.file-box{display:flex;align-items:center;gap:8px}
.file-btn{padding:8px 10px;border-radius:8px;border:1px solid #ccc;background:#ccc;cursor:pointer}
.file-name{font-size:14px;color:#333}
.controls{display:flex;gap:10px;align-items:center;margin-top:6px}
button.primary{background:var(--green2);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
button.danger{background:#dc2626;color:#fff;padding:8px 12px;border-radius:8px;border:none;display:none}
table{width:100%;border-collapse:collapse;margin-top:12px;text-align:right}
th,td{border:1px solid #e9e9e9;padding:10px;vertical-align:top}
th{background:#fafafa;color:#111;font-weight:700}
td.problem{max-width:420px;word-wrap:break-word}
tbody tr:hover{background:#fbfffb}
canvas{width:100% !important;height:360px !important;margin-top:10px}
.recordings-list{margin-top:10px}
.agent-block{border:1px solid #eee;padding:10px;border-radius:8px;margin-bottom:8px;background:#fff}
.file-item{display:flex;gap:10px;align-items:center;margin:6px 0}
.file-item .meta{font-size:13px;color:#333}
.muted{color:#666;font-size:13px}
a.download-link{color:#0645ad;text-decoration:none;font-weight:600}
audio{margin-left:8px}
@media(max-width:720px){
  .row{flex-direction:column;align-items:stretch}
  .row label{min-width:unset;text-align:left}
  .small-input{width:100%}
}
</style>
</head>
<body>
<header>
  Callbooking Performance
  <div class="lock-section">
    <span id="lockIcon" class="lock-icon">ğŸ”’</span>
    <button id="adminLoginBtn" class="primary" style="font-size:12px;padding:4px 8px">ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±</button>
    <button id="memberLoginBtn" class="primary" style="font-size:12px;padding:4px 8px">ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø´Ù†Ø§Ø³</button>
  </div>
</header>

<main>
  <!-- Ø¢Ù…ÙˆØ²Ø´ -->
  <div class="card">
    <h2>Ù…Ø´Ú©Ù„Ø§Øª Ùˆ Ù†ÛŒØ§Ø² Ø¢Ù…ÙˆØ²Ø´ÛŒ Ú©Ø§Ø±Ø´Ù†Ø§Ø³Ø§Ù† / Ø«Ø¨Øª ØªÙˆØ³Ø· ØªÛŒÙ… Ø¢Ù…ÙˆØ²Ø´</h2>
    <form id="trainingForm" autocomplete="off" onsubmit="return false;">
      <div class="row">
        <label for="trainingName">Ù†Ø§Ù… Ú©Ø§Ø±Ø´Ù†Ø§Ø³</label>
        <input id="trainingName" class="small-input" type="text"/>
      </div>
      <div class="row">
        <label for="trainingScore">Ø§Ù…ØªÛŒØ§Ø²</label>
        <input id="trainingScore" class="small-input" type="number" min="0" max="80"/>
      </div>
      <div class="row">
        <label for="trainingIssue">Ù…Ø´Ú©Ù„Ø§Øª Ú©Ø§Ø±Ø´Ù†Ø§Ø³</label>
        <input id="trainingIssue" class="full-input" type="text"/>
      </div>
      <div class="row">
        <label>ÙØ§ÛŒÙ„ Ø´Ù†ÙˆØ¯</label>
        <div class="file-box">
          <button type="button" id="chooseFileBtn" class="file-btn">Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„</button>
          <span id="fileLabel" class="file-name">ÙØ§ÛŒÙ„ Ø´Ù†ÙˆØ¯</span>
          <input id="audioFile" type="file" style="display:none"/>
        </div>
      </div>
      <div class="controls">
        <button id="submitTraining" class="primary" type="button">Ø«Ø¨Øª</button>
        <button id="resetTraining" class="danger" type="button">Ø±ÛŒØ³Øª</button>
      </div>
    </form>
    <table id="trainingTable">
      <thead><tr><th>Ù†Ø§Ù… Ú©Ø§Ø±Ø´Ù†Ø§Ø³</th><th>Ø§Ù…ØªÛŒØ§Ø²</th><th>Ù…Ø´Ú©Ù„Ø§Øª Ú©Ø§Ø±Ø´Ù†Ø§Ø³</th><th>Ø´Ù†ÙˆØ¯</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Ú©ÙˆØ±Ø¯ÛŒÙ†Ø§ØªÙˆØ±Ù‡Ø§ -->
  <div class="card">
    <h2>Ú©Ø§Ø±Ø´Ù†Ø§Ø³Ø§Ù† Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø¨Ù‡ Ø¯ÙˆØ±Ù‡ Ù‡Ù…Ø±Ø§Ù‡ÛŒ / Ø«Ø¨Øª ØªÙˆØ³Ø· Ú©ÙˆØ±Ø¯ÛŒÙ†Ø§ØªÙˆØ±</h2>
    <form id="callForm" autocomplete="off" onsubmit="return false;">
      <div class="row">
        <label for="agentName">Ù†Ø§Ù… Ú©Ø§Ø±Ø´Ù†Ø§Ø³</label>
        <input id="agentName" class="small-input" type="text"/>
      </div>
      <div class="row">
        <label for="coordinatorName2">Ù†Ø§Ù… Ú©ÙˆØ±Ø¯ÛŒÙ†Ø§ØªÙˆØ±</label>
        <input id="coordinatorName2" class="small-input" type="text"/>
      </div>
      <div class="row">
        <label for="note2">Ù…Ø´Ú©Ù„Ø§Øª Ú©Ø§Ø±Ø´Ù†Ø§Ø³</label>
        <input id="note2" class="full-input" type="text"/>
      </div>
      <div class="controls">
        <button id="submitCall" class="primary" type="button">Ø«Ø¨Øª</button>
        <button id="resetCall" class="danger" type="button">Ø±ÛŒØ³Øª</button>
      </div>
    </form>
    <table id="agentsTable">
      <thead><tr><th>Ù†Ø§Ù… Ú©Ø§Ø±Ø´Ù†Ø§Ø³</th><th>Ù†Ø§Ù… Ú©ÙˆØ±Ø¯ÛŒÙ†Ø§ØªÙˆØ±</th><th>Ù…Ø´Ú©Ù„Ø§Øª Ú©Ø§Ø±Ø´Ù†Ø§Ø³</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Ù†Ù…ÙˆØ¯Ø§Ø± -->
  <div class="card">
    <h2>Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§Ø±Ø´Ù†Ø§Ø³Ø§Ù†</h2>
    <canvas id="performanceChart"></canvas>
  </div>

  <!-- ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø´Ù†ÙˆØ¯ -->
  <div class="card">
    <h2>ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø´Ù†ÙˆØ¯ (Ù…Ø±ØªØ¨â€ŒØ´Ø¯Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ø§Ø±Ø´Ù†Ø§Ø³)</h2>
    <div id="recordingsContainer" class="recordings-list"></div>
    <div class="muted">ÙÙ‚Ø· Ù…Ø¯ÛŒØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù¾Ø®Ø´ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†Ø¯.</div>
  </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const KEY_TRAININGS='cb_trainings_final_v3';
const KEY_CALLS='cb_calls_final_v3';
let isAdmin=false;
let isMember=false;

// login
const lockIcon=document.getElementById('lockIcon');
const adminLoginBtn=document.getElementById('adminLoginBtn');
const memberLoginBtn=document.getElementById('memberLoginBtn');

adminLoginBtn.addEventListener('click',()=>{
  const u=prompt('User:'); const p=prompt('Password:');
  if(u==='admin' && p==='123456'){ isAdmin=true; alert('Ù…Ø¯ÛŒØ± ÙˆØ§Ø±Ø¯ Ø´Ø¯'); lockIcon.textContent='ğŸ”“'; renderAll(); }
});
memberLoginBtn.addEventListener('click',()=>{
  const u=prompt('User:'); const p=prompt('Password:');
  if(u==='member' && p==='654321'){ isMember=true; alert('Ú©Ø§Ø±Ø´Ù†Ø§Ø³ ÙˆØ§Ø±Ø¯ Ø´Ø¯'); renderAll(); }
});

const audioFileInput=document.getElementById('audioFile');
const chooseFileBtn=document.getElementById('chooseFileBtn');
const fileLabel=document.getElementById('fileLabel');

const trainingNameEl=document.getElementById('trainingName');
const trainingScoreEl=document.getElementById('trainingScore');
const trainingIssueEl=document.getElementById('trainingIssue');
const submitTrainingBtn=document.getElementById('submitTraining');
const resetTrainingBtn=document.getElementById('resetTraining');
const trainingTableBody=document.querySelector('#trainingTable tbody');

const agentNameEl=document.getElementById('agentName');
const coordEl=document.getElementById('coordinatorName2');
const noteEl=document.getElementById('note2');
const submitCallBtn=document.getElementById('submitCall');
const resetCallBtn=document.getElementById('resetCall');
const agentsTableBody=document.querySelector('#agentsTable tbody');

const recordingsContainer=document.getElementById('recordingsContainer');

function readTrainings(){ try{return JSON.parse(localStorage.getItem(KEY_TRAININGS)||'[]');}catch(e){return[];}}
function writeTrainings(arr){localStorage.setItem(KEY_TRAININGS,JSON.stringify(arr));}
function readCalls(){ try{return JSON.parse(localStorage.getItem(KEY_CALLS)||'[]');}catch(e){return[];}}
function writeCalls(arr){localStorage.setItem(KEY_CALLS,JSON.stringify(arr));}

function fileToBase64(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=e=>rej(e);r.readAsDataURL(file);});}

chooseFileBtn.addEventListener('click',()=>audioFileInput.click());
audioFileInput.addEventListener('change',()=>{fileLabel.textContent=(audioFileInput.files.length>0)?audioFileInput.files[0].name:'ÙØ§ÛŒÙ„ Ø´Ù†ÙˆØ¯';});

function renderTrainings(){
  const arr=readTrainings();
  const yellow=arr.filter(x=>Number(x.score)>=60).sort((a,b)=>b.score-a.score);
  const red=arr.filter(x=>Number(x.score)<60).sort((a,b)=>b.score-a.score);
  const all=[...yellow,...red];
  trainingTableBody.innerHTML='';
  all.forEach(item=>{
    const tr=document.createElement('tr');
    tr.style.background=Number(item.score)>=60?'var(--yellow)':'#f28b91cc';
    const tdName=document.createElement('td'); tdName.textContent=item.name||'';
    const tdScore=document.createElement('td'); tdScore.textContent=item.score!=null?item.score:'';
    const tdIssue=document.createElement('td'); tdIssue.className='problem'; tdIssue.textContent=item.issue||'';
    const tdFile=document.createElement('td');
    if(item.fileName && item.fileData){
      const span=document.createElement('div'); span.textContent=item.fileName; tdFile.appendChild(span);
      if(isAdmin){
        const audio=document.createElement('audio'); audio.controls=true; audio.src=item.fileData; tdFile.appendChild(audio);
        const a=document.createElement('a'); a.href=item.fileData; a.download=item.fileName; a.className='download-link'; a.textContent='Ø¯Ø§Ù†Ù„ÙˆØ¯'; tdFile.appendChild(a);
      }
    } else tdFile.textContent='';
    tr.appendChild(tdName); tr.appendChild(tdScore); tr.appendChild(tdIssue); tr.appendChild(tdFile);
    trainingTableBody.appendChild(tr);
  });
  updateChart(); renderRecordingsList();
}

function renderCalls(){
  const arr=readCalls(); agentsTableBody.innerHTML='';
  arr.forEach(item=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=item.name||'';
    const td2=document.createElement('td'); td2.textContent=item.coord||'';
    const td3=document.createElement('td'); td3.className='problem'; td3.textContent=item.note||'';
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); agentsTableBody.appendChild(tr);
  });
}

function renderRecordingsList(){
  const arr=readTrainings(); const map={};
  arr.forEach(item=>{
    if(!item.fileName||!item.fileData)return;
    if(!map[item.name]) map[item.name]=[];
    map[item.name].push({fileName:item.fileName,fileData:item.fileData,date:item.date||item.createdAt||new Date().toISOString()});
  });
  recordingsContainer.innerHTML='';
  const names=Object.keys(map).sort();
  if(names.length===0){ recordingsContainer.innerHTML='<div class="muted">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ Ø´Ù†ÙˆØ¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>'; return;}
  names.forEach(name=>{
    const block=document.createElement('div'); block.className='agent-block';
    const h=document.createElement('div'); h.style.fontWeight='700'; h.style.marginBottom='8px'; h.textContent=name; block.appendChild(h);
    const files=map[name].sort((a,b)=>(b.date||'').localeCompare(a.date||''));
    files.forEach(f=>{
      const fi=document.createElement('div'); fi.className='file-item';
      const meta=document.createElement('div'); meta.className='meta'; meta.textContent=f.fileName+' Â· '+(new Date(f.date).toLocaleString()); fi.appendChild(meta);
      if(isAdmin){
        const audio=document.createElement('audio'); audio.controls=true; audio.src=f.fileData; fi.appendChild(audio);
        const a=document.createElement('a'); a.href=f.fileData; a.download=f.fileName; a.className='download-link'; a.textContent='Ø¯Ø§Ù†Ù„ÙˆØ¯'; fi.appendChild(a);
      }
      block.appendChild(fi);
    });
    recordingsContainer.appendChild(block);
  });
}

submitTrainingBtn.addEventListener('click',async()=>{
  if(!isAdmin&&!isMember){ alert('ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ±ÙˆØ¯ Ø§Ù…Ú©Ø§Ù† Ø«Ø¨Øª Ø§Ø³Øª'); return;}
  const name=trainingNameEl.value.trim(); let score=Number(trainingScoreEl.value); const issue=trainingIssueEl.value.trim();
  if(!name||!issue){ alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ù…Ø´Ú©Ù„Ø§Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.'); return;}
  if(isNaN(score)) score=0; if(score<0) score=0; if(score>80){ alert('Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 0 ØªØ§ 80 Ø¨Ø§Ø´Ø¯'); return;}
  let fileName=''; let fileData=null;
  if(audioFileInput.files && audioFileInput.files.length>0){ fileName=audioFileInput.files[0].name; try{fileData=await fileToBase64(audioFileInput.files[0]);}catch(e){alert('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„'); return;}}
  const arr=readTrainings(); arr.push({name,score,issue,fileName,fileData,createdAt:new Date().toISOString()}); writeTrainings(arr); renderTrainings();
  trainingNameEl.value=''; trainingScoreEl.value=''; trainingIssueEl.value=''; audioFileInput.value=''; fileLabel.textContent='ÙØ§ÛŒÙ„ Ø´Ù†ÙˆØ¯';
});

submitCallBtn.addEventListener('click',()=>{
  if(!isAdmin&&!isMember){ alert('ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ±ÙˆØ¯ Ø§Ù…Ú©Ø§Ù† Ø«Ø¨Øª Ø§Ø³Øª'); return;}
  const name=agentNameEl.value.trim(); const coord=coordEl.value.trim(); const note=noteEl.value.trim();
  if(!name){ alert('Ù†Ø§Ù… Ú©Ø§Ø±Ø´Ù†Ø§Ø³ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.'); return;}
  const arr=readCalls(); arr.push({name,coord,note,createdAt:new Date().toISOString()}); writeCalls(arr); renderCalls();
  agentNameEl.value=''; coordEl.value=''; noteEl.value='';
});

resetTrainingBtn.addEventListener('click',()=>{
  if(!isAdmin){ alert('ÙÙ‚Ø· Ù…Ø¯ÛŒØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø±ÛŒØ³Øª Ú©Ù†Ø¯'); return;}
  if(!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ')) return;
  writeTrainings([]); renderTrainings();
});
resetCallBtn.addEventListener('click',()=>{
  if(!isAdmin){ alert('ÙÙ‚Ø· Ù…Ø¯ÛŒØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø±ÛŒØ³Øª Ú©Ù†Ø¯'); return;}
  if(!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ…Ø§Ø³ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ')) return;
  writeCalls([]); renderCalls();
});

// chart
const ctx=document.getElementById('performanceChart').getContext('2d');
let chart=null;
function updateChart(){
  const arr=readTrainings();
  const yellow=arr.filter(x=>Number(x.score)>=60).sort((a,b)=>b.score-a.score);
  const red=arr.filter(x=>Number(x.score)<60).sort((a,b)=>b.score-a.score);
  const sorted=[...yellow,...red];
  const labels=sorted.map(s=>s.name||''); const data=sorted.map(s=>Number(s.score||0));
  const bg=sorted.map(s=>Number(s.score)>=60?var(--yellow):'#f28b91cc');
  const border=sorted.map(s=>Number(s.score)>=60?'goldenrod':'darkred');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Ø§Ù…ØªÛŒØ§Ø²',data,backgroundColor:bg,borderColor:border,borderWidth:1}]},options:{responsive:true,scales:{y:{beginAtZero:true,suggestedMax:80}}}});
}

function renderAll(){ renderTrainings(); renderCalls(); }

renderAll();
</script>
</body>
</html>
