<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Callbooking Performance</title>
<style>
  :root{
    --green1:#66d17a;
    --green2:#0b7a3f;
    --yellow:#fef3c7;
    --red:#e05d64;
    --bg:#f0f2f5;
    --gold:#d4af37;
  }
  *{box-sizing:border-box}
  body{font-family:Calibri, sans-serif;background:var(--bg);margin:0;padding:0;direction:rtl;color:#111}
  header{
    background:linear-gradient(90deg,var(--green1),var(--green2));
    color:#fff;padding:16px;text-align:center;font-size:22px;font-weight:800;
    box-shadow:0 4px 12px rgba(0,0,0,0.12); position:relative;
  }
  #adminLoginBtn{
    position:absolute; left:12px; top:10px; background:transparent;border:0;color:#fff; cursor:pointer;
    display:flex;align-items:center;gap:8px;font-weight:700;padding:6px 8px;border-radius:6px;
  }
  #adminLock{font-size:18px;color:#fff}
  #adminLock.open{ color: var(--gold); }
  main{max-width:1100px;margin:18px auto;padding:16px;display:flex;flex-direction:column;gap:16px}
  .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  h2{margin:0 0 10px;color:var(--green2);font-size:18px}
  .row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .row label{min-width:140px;text-align:right;font-weight:600}
  .small-input{width:260px;padding:8px;border:1px solid #ccc;border-radius:8px;font-size:14px}
  .full-input{flex:1;padding:8px;border:1px solid #ccc;border-radius:8px;font-size:14px}
  input[type=file]{padding:8px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
  .controls{display:flex;gap:10px;align-items:center;margin-top:6px}
  button.primary{background:#10b981;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  button.danger{background:#dc2626;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;display:none}
  table{width:100%;border-collapse:collapse;margin-top:12px;text-align:right}
  th,td{border:1px solid #e9e9e9;padding:10px;vertical-align:top}
  th{background:#fafafa;color:#111;font-weight:700}
  td.problem{max-width:420px;word-wrap:break-word}
  tbody tr:hover{background:#fbfffb}
  canvas{width:100% !important;height:360px !important;margin-top:10px}
  .recordings-list{margin-top:10px}
  .agent-block{border:1px solid #eee;padding:10px;border-radius:8px;margin-bottom:8px;background:#fff}
  .file-item{display:flex;gap:10px;align-items:center;margin:6px 0;flex-wrap:wrap}
  .file-item .meta{font-size:13px;color:#333;min-width:160px}
  .muted{color:#666;font-size:13px}
  a.download-link{color:#0645ad;text-decoration:none;font-weight:600}
  audio{margin-left:8px;max-width:320px}
  @media(max-width:720px){
    .row{flex-direction:column;align-items:stretch}
    .row label{min-width:unset;text-align:left}
    .small-input{width:100%}
  }
</style>
</head>
<body>
<header>
  Callbooking Performance
  <button id="adminLoginBtn" title="ورود مدیر">
    <span id="adminLock">🔒</span>
    <span style="display:none" id="adminLabel">ورود مدیر</span>
  </button>
</header>

<main>
  <!-- آموزش -->
  <div class="card">
    <h2>مشکلات و نیاز آموزشی کارشناسان / ثبت توسط تیم آموزش</h2>
    <form id="trainingForm" autocomplete="off" onsubmit="return false;">
      <div class="row">
        <label for="trainingName">نام کارشناس</label>
        <input id="trainingName" class="small-input" type="text" />
      </div>

      <div class="row">
        <label for="trainingScore">امتیاز</label>
        <input id="trainingScore" class="small-input" type="number" min="0" max="80" />
      </div>

      <div class="row">
        <label for="trainingIssue">مشکلات کارشناس</label>
        <input id="trainingIssue" class="full-input" type="text" />
      </div>

      <div class="row">
        <label for="audioFile">فایل شنود</label>
        <!-- فقط یک input file ساده (Choose file) -->
        <input id="audioFile" type="file" accept="audio/*" />
      </div>

      <div class="controls">
        <button id="submitTraining" class="primary" type="button">ثبت</button>
        <button id="resetTraining" class="danger" type="button">ریست</button>
      </div>
    </form>

    <table id="trainingTable" aria-label="training-table">
      <thead><tr><th>نام کارشناس</th><th>امتیاز</th><th>مشکلات کارشناس</th><th>شنود</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- کوردیناتورها -->
  <div class="card">
    <h2>کارشناسان نیازمند به دوره همراهی / ثبت توسط کوردیناتورها</h2>
    <form id="callForm" autocomplete="off" onsubmit="return false;">
      <div class="row">
        <label for="agentName">نام کارشناس</label>
        <input id="agentName" class="small-input" type="text" />
      </div>

      <div class="row">
        <label for="coordinatorName2">نام کوردیناتور</label>
        <input id="coordinatorName2" class="small-input" type="text" />
      </div>

      <div class="row">
        <label for="note2">مشکلات کارشناس</label>
        <input id="note2" class="full-input" type="text" />
      </div>

      <div class="controls">
        <button id="submitCall" class="primary" type="button">ثبت</button>
        <button id="resetCall" class="danger" type="button">ریست</button>
      </div>
    </form>

    <table id="agentsTable">
      <thead><tr><th>نام کارشناس</th><th>نام کوردیناتور</th><th>مشکلات کارشناس</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- نمودار -->
  <div class="card">
    <h2>امتیاز کارشناسان</h2>
    <canvas id="performanceChart"></canvas>
  </div>

  <!-- بخش مرتب فایل‌های شنود بر اساس کارشناس -->
  <div class="card">
    <h2>فایل‌های شنود (مرتب‌شده بر اساس کارشناس)</h2>
    <div id="recordingsContainer" class="recordings-list"></div>
    <div class="muted">فایل‌ها با تاریخ آپلود مرتب شده‌اند؛ فقط مدیر می‌تواند پخش و دانلود کند.</div>
  </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* Keys */
const KEY_TRAININGS = 'cb_trainings_final_v4';
const KEY_CALLS = 'cb_calls_final_v4';

/* Admin state (in-memory only => refresh resets) */
let isAdmin = false;

/* Elements */
const adminLoginBtn = document.getElementById('adminLoginBtn');
const adminLock = document.getElementById('adminLock');

const trainingNameEl = document.getElementById('trainingName');
const trainingScoreEl = document.getElementById('trainingScore');
const trainingIssueEl = document.getElementById('trainingIssue');
const audioFileInput = document.getElementById('audioFile');
const submitTrainingBtn = document.getElementById('submitTraining');
const resetTrainingBtn = document.getElementById('resetTraining');
const trainingTableBody = document.querySelector('#trainingTable tbody');

const agentNameEl = document.getElementById('agentName');
const coordEl = document.getElementById('coordinatorName2');
const noteEl = document.getElementById('note2');
const submitCallBtn = document.getElementById('submitCall');
const resetCallBtn = document.getElementById('resetCall');
const agentsTableBody = document.querySelector('#agentsTable tbody');

const recordingsContainer = document.getElementById('recordingsContainer');

/* Storage helpers */
function readTrainings(){ try { return JSON.parse(localStorage.getItem(KEY_TRAININGS) || '[]'); } catch(e){ return []; } }
function writeTrainings(arr){ localStorage.setItem(KEY_TRAININGS, JSON.stringify(arr)); }
function readCalls(){ try { return JSON.parse(localStorage.getItem(KEY_CALLS) || '[]'); } catch(e){ return []; } }
function writeCalls(arr){ localStorage.setItem(KEY_CALLS, JSON.stringify(arr)); }

/* File helper */
function fileToBase64(file){
  return new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.onerror = e=> rej(e);
    r.readAsDataURL(file);
  });
}

/* Admin login (only one, top-left) */
adminLoginBtn.addEventListener('click', async ()=>{
  const user = prompt('User:');
  const pass = prompt('Password:');
  if(user === 'admin' && pass === 'admin1'){
    isAdmin = true;
    adminLock.classList.add('open'); // golden color
    adminLock.textContent = '🔓';
    // show reset buttons
    resetTrainingBtn.style.display = 'inline-block';
    resetCallBtn.style.display = 'inline-block';
    renderAll();
    alert('ورود مدیر موفق — اکنون می‌توانید شنودها را پخش و دانلود کنید و ریست انجام دهید.');
  } else {
    alert('نام کاربری یا رمز اشتباه است');
  }
});

/* Rendering helpers */
function renderTrainings(){
  const arr = readTrainings();
  trainingTableBody.innerHTML = '';
  // group: yellow (>=60) then red (<60) — both sorted desc
  const yellow = arr.filter(x=>Number(x.score) >= 60).sort((a,b)=>b.score-a.score);
  const red = arr.filter(x=>Number(x.score) < 60).sort((a,b)=>b.score-a.score);
  const all = [...yellow, ...red];
  all.forEach(item=>{
    const tr = document.createElement('tr');
    tr.style.background = Number(item.score) >= 60 ? 'var(--yellow)' : 'var(--red)';
    const tdName = document.createElement('td'); tdName.textContent = item.name || '';
    const tdScore = document.createElement('td'); tdScore.textContent = item.score != null ? item.score : '';
    const tdIssue = document.createElement('td'); tdIssue.className = 'problem'; tdIssue.textContent = item.issue || '';
    const tdFile = document.createElement('td');
    if(item.fileName){
      const fname = document.createElement('div'); fname.textContent = item.fileName; tdFile.appendChild(fname);
      if(isAdmin && item.fileData){
        const audio = document.createElement('audio'); audio.controls = true; audio.src = item.fileData; tdFile.appendChild(audio);
        const dl = document.createElement('a'); dl.href = item.fileData; dl.download = item.fileName; dl.className='download-link'; dl.textContent = 'دانلود'; dl.style.display='inline-block'; dl.style.marginLeft='8px'; tdFile.appendChild(dl);
      } else {
        const note = document.createElement('div'); note.className='muted'; note.textContent = 'بارگذاری شده';
        tdFile.appendChild(note);
      }
    }
    tr.appendChild(tdName); tr.appendChild(tdScore); tr.appendChild(tdIssue); tr.appendChild(tdFile);
    trainingTableBody.appendChild(tr);
  });
  renderRecordingsList();
  updateChart();
}

function renderCalls(){
  const arr = readCalls();
  agentsTableBody.innerHTML = '';
  arr.forEach(item=>{
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent = item.name || '';
    const td2 = document.createElement('td'); td2.textContent = item.coord || '';
    const td3 = document.createElement('td'); td3.className='problem'; td3.textContent = item.note || '';
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    agentsTableBody.appendChild(tr);
  });
}

function renderRecordingsList(){
  const arr = readTrainings();
  const map = {};
  arr.forEach(item=>{
    if(!item.fileName || !item.fileData) return;
    if(!map[item.name]) map[item.name]=[];
    map[item.name].push({ fileName:item.fileName, fileData:item.fileData, date:item.createdAt || new Date().toISOString() });
  });
  recordingsContainer.innerHTML = '';
  const names = Object.keys(map).sort();
  if(names.length === 0){ recordingsContainer.innerHTML = '<div class="muted">هنوز هیچ فایل شنودی ثبت نشده</div>'; return; }
  names.forEach(name=>{
    const block = document.createElement('div'); block.className='agent-block';
    const h = document.createElement('div'); h.style.fontWeight='700'; h.style.marginBottom='8px'; h.textContent = name;
    block.appendChild(h);
    const files = map[name].sort((a,b)=> (b.date||'').localeCompare(a.date||'') );
    files.forEach(f=>{
      const fi = document.createElement('div'); fi.className='file-item';
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = f.fileName + ' · ' + (new Date(f.date).toLocaleString());
      fi.appendChild(meta);
      if(isAdmin){
        const audio = document.createElement('audio'); audio.controls = true; audio.src = f.fileData; audio.style.marginLeft='6px'; fi.appendChild(audio);
        const a = document.createElement('a'); a.href = f.fileData; a.download = f.fileName; a.className='download-link'; a.textContent = 'دانلود'; a.style.marginLeft='8px'; fi.appendChild(a);
      } else {
        const note = document.createElement('div'); note.className='muted'; note.textContent = 'فایل بارگذاری شده — دانلود برای مدیر';
        fi.appendChild(note);
      }
      block.appendChild(fi);
    });
    recordingsContainer.appendChild(block);
  });
}

/* Chart */
const ctx = document.getElementById('performanceChart').getContext('2d');
let chart = null;
function updateChart(){
  const arr = readTrainings();
  const yellow = arr.filter(x=>Number(x.score) >= 60).sort((a,b)=>b.score-a.score);
  const red = arr.filter(x=>Number(x.score) < 60).sort((a,b)=>b.score-a.score);
  const sorted = [...yellow, ...red];
  const labels = sorted.map(s=> s.name || '');
  const data = sorted.map(s=> Number(s.score || 0));
  const bg = sorted.map(s=> Number(s.score) >= 60 ? '#fef3c7' : '#e05d64');
  const border = sorted.map(s=> Number(s.score) >= 60 ? 'goldenrod' : '#8b1c1c');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label:'امتیاز', data, backgroundColor: bg, borderColor: border, borderWidth: 1 }]},
    options: { responsive:true, scales:{ y:{ beginAtZero:true, suggestedMax:80 } } }
  });
}

/* Submit handlers (always allow submitting) */
submitTrainingBtn.addEventListener('click', async ()=>{
  const name = trainingNameEl.value.trim();
  let score = Number(trainingScoreEl.value);
  const issue = trainingIssueEl.value.trim();
  if(!name || !issue){ alert('لطفاً نام و مشکلات را وارد کنید.'); return; }
  if(isNaN(score)) score = 0;
  if(score < 0) score = 0;
  if(score > 80){ alert('امتیاز باید بین 0 تا 80 باشد'); return; }

  let fileName = '';
  let fileData = null;
  if(audioFileInput.files && audioFileInput.files.length > 0){
    fileName = audioFileInput.files[0].name;
    try { fileData = await fileToBase64(audioFileInput.files[0]); } catch(e){ console.error(e); alert('خطا در خواندن فایل'); return; }
  }

  const arr = readTrainings();
  arr.push({ name, score, issue, fileName, fileData, createdAt: new Date().toISOString() });
  writeTrainings(arr);
  renderTrainings();

  trainingNameEl.value=''; trainingScoreEl.value=''; trainingIssueEl.value=''; audioFileInput.value='';
});

/* Calls submit */
submitCallBtn.addEventListener('click', ()=>{
  const name = agentNameEl.value.trim();
  const coord = coordEl.value.trim();
  const note = noteEl.value.trim();
  if(!name){ alert('نام کارشناس الزامی است.'); return; }
  const arr = readCalls();
  arr.push({ name, coord, note, createdAt: new Date().toISOString() });
  writeCalls(arr);
  renderCalls();
  agentNameEl.value=''; coordEl.value=''; noteEl.value='';
});

/* Reset (admin only) */
resetTrainingBtn.addEventListener('click', ()=>{
  if(!isAdmin){ alert('فقط مدیر می‌تواند ریست کند'); return; }
  if(!confirm('آیا مطمئن هستید همه داده‌های آموزش پاک شوند؟')) return;
  writeTrainings([]); renderTrainings();
});
resetCallBtn.addEventListener('click', ()=>{
  if(!isAdmin){ alert('فقط مدیر می‌تواند ریست کند'); return; }
  if(!confirm('آیا مطمئن هستید همه داده‌های تماس پاک شوند؟')) return;
  writeCalls([]); renderCalls();
});

/* Initial UI state: hide reset buttons (only visible after admin login) */
resetTrainingBtn.style.display = 'none';
resetCallBtn.style.display = 'none';

/* Initial render */
renderTrainings();
renderCalls();

</script>
</body>
</html>
