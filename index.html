<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Callbooking Performance</title>
<style>
  :root{
    --green1:#66d17a;
    --green2:#0b7a3f;
    --yellow:#fef3c7;
    --red:#e05d64; /* Ù‚Ø±Ù…Ø² Ú©Ù…â€ŒØ±Ù†Ú¯ */
    --bg:#f0f2f5;
  }
  *{box-sizing:border-box}
  body{font-family:Calibri, sans-serif;background:var(--bg);margin:0;padding:0;direction:rtl;color:#111}
  header{
    background:linear-gradient(90deg,var(--green1),var(--green2));
    color:#fff;padding:20px;text-align:center;font-size:24px;font-weight:800;
    box-shadow:0 4px 12px rgba(0,0,0,0.12)
  }
  main{max-width:1100px;margin:18px auto;padding:16px;display:flex;flex-direction:column;gap:16px}
  .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  h2{margin:0 0 10px;color:var(--green2);font-size:18px}
  .row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .row label{min-width:140px;text-align:right;font-weight:600}
  .small-input{width:260px;padding:8px;border:1px solid #ccc;border-radius:8px;font-size:14px}
  .full-input{flex:1;padding:8px;border:1px solid #ccc;border-radius:8px;font-size:14px}
  .file-box{display:flex;align-items:center;gap:8px}
  .file-btn{padding:8px 10px;border-radius:8px;border:1px solid #ccc;background:#d1d5db;cursor:pointer} /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ */
  .file-name{font-size:14px;color:#333}
  .controls{display:flex;gap:10px;align-items:center;margin-top:6px}
  button.primary{background:#10b981;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600} /* Ø«Ø¨Øª Ø³Ø¨Ø² */
  button.danger{background:#dc2626;color:#fff;padding:8px 12px;border-radius:8px;border:none;display:none;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:12px;text-align:right}
  th,td{border:1px solid #e9e9e9;padding:10px;vertical-align:top}
  th{background:#fafafa;color:#111;font-weight:700}
  td.problem{max-width:420px;word-wrap:break-word}
  tbody tr:hover{background:#fbfffb}
  canvas{width:100% !important;height:360px !important;margin-top:10px}
  .recordings-list{margin-top:10px}
  .agent-block{border:1px solid #eee;padding:10px;border-radius:8px;margin-bottom:8px;background:#fff}
  .file-item{display:flex;gap:10px;align-items:center;margin:6px 0}
  .file-item .meta{font-size:13px;color:#333}
  .muted{color:#666;font-size:13px}
  a.download-link{color:#0645ad;text-decoration:none;font-weight:600}
  audio{margin-left:8px}
  .login-container{display:flex;gap:10px;justify-content:flex-start;margin-bottom:12px}
  .login-btn{background:#fbbf24;color:#111;padding:6px 10px;border-radius:6px;border:none;cursor:pointer;font-size:14px}
  @media(max-width:720px){
    .row{flex-direction:column;align-items:stretch}
    .row label{min-width:unset;text-align:left}
    .small-input{width:100%}
  }
</style>
</head>
<body>
<header>Callbooking Performance</header>
<main>

<div class="login-container">
  <button id="loginAdminBtn" class="login-btn">ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ± ğŸ”’</button>
  <button id="loginUserBtn" class="login-btn">ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø´Ù†Ø§Ø³</button>
</div>

<!-- Ø¢Ù…ÙˆØ²Ø´ -->
<div class="card">
  <h2>Ù…Ø´Ú©Ù„Ø§Øª Ùˆ Ù†ÛŒØ§Ø² Ø¢Ù…ÙˆØ²Ø´ÛŒ Ú©Ø§Ø±Ø´Ù†Ø§Ø³Ø§Ù† / Ø«Ø¨Øª ØªÙˆØ³Ø· ØªÛŒÙ… Ø¢Ù…ÙˆØ²Ø´</h2>
  <form id="trainingForm" autocomplete="off" onsubmit="return false;">
    <div class="row">
      <label for="trainingName">Ù†Ø§Ù… Ú©Ø§Ø±Ø´Ù†Ø§Ø³</label>
      <input id="trainingName" class="small-input" type="text" disabled />
    </div>
    <div class="row">
      <label for="trainingScore">Ø§Ù…ØªÛŒØ§Ø²</label>
      <input id="trainingScore" class="small-input" type="number" min="0" max="80" disabled />
    </div>
    <div class="row">
      <label for="trainingIssue">Ù…Ø´Ú©Ù„Ø§Øª Ú©Ø§Ø±Ø´Ù†Ø§Ø³</label>
      <input id="trainingIssue" class="full-input" type="text" disabled />
    </div>
    <div class="row">
      <label>ÙØ§ÛŒÙ„ Ø´Ù†ÙˆØ¯</label>
      <input id="audioFile" type="file" class="file-btn" disabled />
    </div>
    <div class="controls">
      <button id="submitTraining" class="primary" type="button" disabled>Ø«Ø¨Øª</button>
      <button id="resetTraining" class="danger" type="button">Ø±ÛŒØ³Øª (Ù…Ø¯ÛŒØ±)</button>
    </div>
  </form>
  <table id="trainingTable">
    <thead><tr><th>Ù†Ø§Ù… Ú©Ø§Ø±Ø´Ù†Ø§Ø³</th><th>Ø§Ù…ØªÛŒØ§Ø²</th><th>Ù…Ø´Ú©Ù„Ø§Øª Ú©Ø§Ø±Ø´Ù†Ø§Ø³</th><th>Ø´Ù†ÙˆØ¯</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- Ú©ÙˆØ±Ø¯ÛŒÙ†Ø§ØªÙˆØ±Ù‡Ø§ -->
<div class="card">
  <h2>Ú©Ø§Ø±Ø´Ù†Ø§Ø³Ø§Ù† Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø¨Ù‡ Ø¯ÙˆØ±Ù‡ Ù‡Ù…Ø±Ø§Ù‡ÛŒ / Ø«Ø¨Øª ØªÙˆØ³Ø· Ú©ÙˆØ±Ø¯ÛŒÙ†Ø§ØªÙˆØ±</h2>
  <form id="callForm" autocomplete="off" onsubmit="return false;">
    <div class="row">
      <label for="agentName">Ù†Ø§Ù… Ú©Ø§Ø±Ø´Ù†Ø§Ø³</label>
      <input id="agentName" class="small-input" type="text" disabled />
    </div>
    <div class="row">
      <label for="coordinatorName2">Ù†Ø§Ù… Ú©ÙˆØ±Ø¯ÛŒÙ†Ø§ØªÙˆØ±</label>
      <input id="coordinatorName2" class="small-input" type="text" disabled />
    </div>
    <div class="row">
      <label for="note2">Ù…Ø´Ú©Ù„Ø§Øª Ú©Ø§Ø±Ø´Ù†Ø§Ø³</label>
      <input id="note2" class="full-input" type="text" disabled />
    </div>
    <div class="controls">
      <button id="submitCall" class="primary" type="button" disabled>Ø«Ø¨Øª</button>
      <button id="resetCall" class="danger" type="button">Ø±ÛŒØ³Øª (Ù…Ø¯ÛŒØ±)</button>
    </div>
  </form>
  <table id="agentsTable">
    <thead><tr><th>Ù†Ø§Ù… Ú©Ø§Ø±Ø´Ù†Ø§Ø³</th><th>Ù†Ø§Ù… Ú©ÙˆØ±Ø¯ÛŒÙ†Ø§ØªÙˆØ±</th><th>Ù…Ø´Ú©Ù„Ø§Øª Ú©Ø§Ø±Ø´Ù†Ø§Ø³</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- Ù†Ù…ÙˆØ¯Ø§Ø± -->
<div class="card">
  <h2>Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§Ø±Ø´Ù†Ø§Ø³Ø§Ù†</h2>
  <canvas id="performanceChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let isAdmin=false, isUser=false;

const adminPwd="123456", userPwd="654321";

const trainingFormEls=[ 'trainingName','trainingScore','trainingIssue','audioFile','submitTraining' ];
const callFormEls=['agentName','coordinatorName2','note2','submitCall'];

function setFormAccess(enable){
  trainingFormEls.forEach(id=>document.getElementById(id).disabled=!enable);
  callFormEls.forEach(id=>document.getElementById(id).disabled=!enable);
}

document.getElementById('loginAdminBtn').addEventListener('click', ()=>{
  const pwd=prompt("User: admin\nPassword:");
  if(pwd===adminPwd){ isAdmin=true; setFormAccess(true); alert("Ù…Ø¯ÛŒØ± ÙˆØ§Ø±Ø¯ Ø´Ø¯"); }
});
document.getElementById('loginUserBtn').addEventListener('click', ()=>{
  const pwd=prompt("User: member\nPassword:");
  if(pwd===userPwd){ isUser=true; setFormAccess(true); alert("Ú©Ø§Ø±Ø´Ù†Ø§Ø³ ÙˆØ§Ø±Ø¯ Ø´Ø¯"); }
});

/* Storage & Rendering */
const KEY_TRAININGS='cb_trainings_final_v2';
const KEY_CALLS='cb_calls_final_v2';

function readTrainings(){ try{ return JSON.parse(localStorage.getItem(KEY_TRAININGS)||'[]'); }catch(e){return[];} }
function writeTrainings(arr){ localStorage.setItem(KEY_TRAININGS, JSON.stringify(arr)); }
function readCalls(){ try{ return JSON.parse(localStorage.getItem(KEY_CALLS)||'[]'); }catch(e){return[];} }
function writeCalls(arr){ localStorage.setItem(KEY_CALLS, JSON.stringify(arr)); }

/* File */
async function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=e=>rej(e); r.readAsDataURL(file); }); }

/* Render Tables */
function renderTrainings(){
  const arr=readTrainings();
  trainingTableBody.innerHTML='';
  arr.forEach(item=>{
    const tr=document.createElement('tr');
    tr.style.background=Number(item.score)>=60? 'var(--yellow)' : 'var(--red)';
    const tdName=document.createElement('td'); tdName.textContent=item.name||'';
    const tdScore=document.createElement('td'); tdScore.textContent=item.score!=null?item.score:'';
    const tdIssue=document.createElement('td'); tdIssue.textContent=item.issue||'';
    const tdFile=document.createElement('td');
    if(item.fileName && item.fileData && isAdmin){
      const audio=document.createElement('audio'); audio.controls=true; audio.src=item.fileData; tdFile.appendChild(audio);
      const a=document.createElement('a'); a.href=item.fileData; a.download=item.fileName; a.textContent='Ø¯Ø§Ù†Ù„ÙˆØ¯'; tdFile.appendChild(a);
    }
    tr.appendChild(tdName); tr.appendChild(tdScore); tr.appendChild(tdIssue); tr.appendChild(tdFile);
    trainingTableBody.appendChild(tr);
  });
  updateChart();
}

function renderCalls(){
  const arr=readCalls();
  agentsTableBody.innerHTML='';
  arr.forEach(item=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=item.name||'';
    const td2=document.createElement('td'); td2.textContent=item.coord||'';
    const td3=document.createElement('td'); td3.textContent=item.note||'';
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    agentsTableBody.appendChild(tr);
  });
}

/* Submit */
document.getElementById('submitTraining').addEventListener('click', async ()=>{
  const name=document.getElementById('trainingName').value.trim();
  let score=Number(document.getElementById('trainingScore').value);
  const issue=document.getElementById('trainingIssue').value.trim();
  const fileInput=document.getElementById('audioFile');
  if(!name||!issue){ alert('Ù†Ø§Ù… Ùˆ Ù…Ø´Ú©Ù„Ø§Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª'); return; }
  if(isNaN(score)) score=0;
  if(score<0) score=0;
  if(score>80){ alert('Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 0 ØªØ§ 80 Ø¨Ø§Ø´Ø¯'); return; }
  let fileName='', fileData=null;
  if(fileInput.files.length>0){ fileName=fileInput.files[0].name; fileData=await fileToBase64(fileInput.files[0]); }
  const arr=readTrainings(); arr.push({name,score,issue,fileName,fileData,createdAt:new Date().toISOString()});
  writeTrainings(arr); renderTrainings();
  document.getElementById('trainingName').value=''; document.getElementById('trainingScore').value=''; document.getElementById('trainingIssue').value=''; fileInput.value='';
});

document.getElementById('submitCall').addEventListener('click', ()=>{
  const name=document.getElementById('agentName').value.trim();
  const coord=document.getElementById('coordinatorName2').value.trim();
  const note=document.getElementById('note2').value.trim();
  if(!name){ alert('Ù†Ø§Ù… Ú©Ø§Ø±Ø´Ù†Ø§Ø³ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª'); return; }
  const arr=readCalls(); arr.push({name,coord,note,createdAt:new Date().toISOString()});
  writeCalls(arr); renderCalls();
});

/* Reset Admin */
document.getElementById('resetTraining').addEventListener('click', ()=>{
  if(!isAdmin){ alert('ÙÙ‚Ø· Ù…Ø¯ÛŒØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø±ÛŒØ³Øª Ú©Ù†Ø¯'); return; }
  if(!confirm('Ù¾Ø§Ú© Ø´Ø¯Ù† Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ØŸ')) return;
  writeTrainings([]); renderTrainings();
});
document.getElementById('resetCall').addEventListener('click', ()=>{
  if(!isAdmin){ alert('ÙÙ‚Ø· Ù…Ø¯ÛŒØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø±ÛŒØ³Øª Ú©Ù†Ø¯'); return; }
  if(!confirm('Ù¾Ø§Ú© Ø´Ø¯Ù† Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ…Ø§Ø³ØŸ')) return;
  writeCalls([]); renderCalls();
});

/* Chart */
const ctx=document.getElementById('performanceChart').getContext('2d');
let chart=null;
function updateChart(){
  const arr=readTrainings();
  const yellow=arr.filter(x=>Number(x.score)>=60).sort((a,b)=>b.score-a.score);
  const red=arr.filter(x=>Number(x.score)<60).sort((a,b)=>b.score-a.score);
  const sorted=[...yellow,...red];
  const labels=sorted.map(s=>s.name||'');
  const data=sorted.map(s=>Number(s.score||0));
  const bg=sorted.map(s=>Number(s.score)>=60? '#fef3c7' : '#e05d64');
  const border=sorted.map(s=>Number(s.score)>=60? 'goldenrod' : 'darkred');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Ø§Ù…ØªÛŒØ§Ø²',data,backgroundColor:bg,borderColor:border,borderWidth:1}]},options:{responsive:true,scales:{y:{beginAtZero:true,suggestedMax:80}}}});
}

/* Initial Render */
const trainingTableBody=document.querySelector('#trainingTable tbody');
const agentsTableBody=document.querySelector('#agentsTable tbody');
renderTrainings(); renderCalls();
</script>
</body>
</html>
